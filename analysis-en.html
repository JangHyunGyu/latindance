<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Dance Video Precision Analysis - Latin Dance Community</title>
	<meta name="description" content="Latin Dance Motion Analysis Engine analyzes your dance video and provides feedback." />
	<link rel="canonical" href="https://latindance.kr/analysis-en.html" />
	<meta name="robots" content="index,follow" />
	<meta property="og:type" content="website" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:site_name" content="Latin Dance Community" />
	<meta property="og:title" content="Dance Video Precision Analysis" />
	<meta property="og:description" content="Latin Dance Motion Analysis Engine analyzes your dance video and provides feedback." />
	<meta property="og:url" content="https://latindance.kr/analysis-en.html" />
	<meta property="og:image" content="https://latindance.kr/assets/images/analysis_kakao_profile.png?v=2" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content="Dance Video Precision Analysis" />
	<meta name="twitter:description" content="Latin Dance Motion Analysis Engine analyzes your dance video and provides feedback." />
	<meta name="twitter:image" content="https://latindance.kr/assets/images/analysis_kakao_profile.png?v=2" />
	
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="icon" type="image/png" href="favicon.png">
	<link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
	<link
		href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=Pretendard:wght@400;500;600;700&display=swap"
		rel="stylesheet">
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.1/kakao.min.js"></script>
	<link rel="stylesheet" href="assets/css/style.css?v=103">
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-197LKDJGPJ"></script>
	<script defer src="assets/js/ga.js"></script>
	<script type="text/javascript" src="https://wcs.pstatic.net/wcslog.js"></script>
	<script type="text/javascript">
		if (!window.wcs_add) window.wcs_add = {};
		window.wcs_add["wa"] = "153975124894190";
		if (window.location.protocol !== 'file:' && window.wcs) {
			wcs_do();
		}
	</script>
    
    <style>
        :root {
            --primary-color: #bd34fe; /* Vite Purple */
            --primary-light: #d27aff;
            --secondary-color: #41d1ff; /* Vite Blue */
            --bg-dark: #0f0e14; /* Deep Dark */
            --surface-dark: #1e1e24;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-vite: linear-gradient(135deg, #41d1ff 0%, #bd34fe 100%);
            --glow-color: rgba(189, 52, 254, 0.5);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 0%, #2c1b4e 0%, transparent 50%),
                radial-gradient(circle at 100% 0%, #1a1625 0%, transparent 30%);
            color: var(--text-main);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .site-main {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal scroll */
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            box-sizing: border-box;
            position: relative;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
        }

        .site-main::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome/Safari */
        }

        /* Background Orbs */
        .site-main::before {
            content: '';
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 100%; /* Prevent orb from causing overflow on small screens */
            height: 400px;
            background: radial-gradient(ellipse at center, rgba(189, 52, 254, 0.15), transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        h1, h2, h3, .hero__title, .modal-title, .site-logo {
            font-family: 'Pretendard', sans-serif;
            word-break: keep-all;
            letter-spacing: -0.02em;
        }

        .hero__title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #41d1ff, #bd34fe, #ff2d88);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
            text-align: center;
        }
        
        .hero__description {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 3.5rem;
            line-height: 1.6;
            font-weight: 400;
            word-break: keep-all;
            text-align: center;
            max-width: 600px;
        }

        @media (max-width: 600px) {
            .hero__title {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            .hero__description {
                font-size: 0.9rem;
                margin-bottom: 1.5rem;
                line-height: 1.4;
            }
        }

        .analysis-container {
            width: 100%;
            max-width: 900px;
            margin: auto;
            padding: 3rem;
            background: rgba(30, 30, 36, 0.6);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            word-break: keep-all;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .analysis-container:hover {
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.8rem;
            text-align: left;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .section-title::before {
            display: none;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2.5rem;
            text-align: left;
        }

        @media (max-width: 600px) {
            html {
                font-size: 13px; /* Slightly smaller base font */
            }

            .site-main {
                padding: 1rem 0.5rem; /* Reduce outer padding */
                justify-content: center; /* Center vertically if space allows */
            }

            .analysis-container {
                width: 100%;
                padding: 1.2rem;
                margin: 0 auto;
                border-radius: 20px;
            }
            
            .options-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.8rem;
                margin-bottom: 1rem;
            }

            .upload-area {
                padding: 1.5rem 1rem !important;
                margin: 1rem 0 !important;
                border-radius: 12px;
            }

            .upload-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }

            .upload-btn-label {
                padding: 10px 20px;
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            #analyzeBtn {
                padding: 16px;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 360px) {
            html {
                font-size: 12px;
            }
        }

        select {
            width: 100%;
            padding: 14px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #1b1b1f;
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            cursor: pointer;
        }

        select:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background: #232329;
        }

        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(189, 52, 254, 0.3);
            background: #1b1b1f;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            padding: 4rem 2rem;
            margin: 2rem 0;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(189, 52, 254, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            opacity: 0.8;
            transition: transform 0.3s ease;
        }
        
        .upload-area:hover .upload-icon {
            transform: scale(1.1);
        }

        .upload-btn-label {
            display: inline-block;
            padding: 14px 32px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 1rem;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        .upload-btn-label:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(189, 52, 254, 0.3);
            transform: translateY(-2px);
            color: var(--primary-light);
        }
        
        .upload-btn-label:active {
            transform: scale(0.95);
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        #videoInput {
            display: none;
        }

        /* Animated Gradient Button for Analyze */
        #analyzeBtn {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 800;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 1.5rem;
            font-family: inherit;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            background: linear-gradient(45deg, #41d1ff, #bd34fe, #ff2d88, #41d1ff);
            background-size: 300% 300%;
            animation: gradient-shift 5s ease infinite;
            box-shadow: 0 10px 30px -10px rgba(189, 52, 254, 0.6);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #analyzeBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
            z-index: -1;
        }

        #analyzeBtn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(189, 52, 254, 0.8);
        }

        #analyzeBtn:hover::before {
            left: 100%;
            transition: left 0.7s ease-in-out;
        }

        #analyzeBtn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 5px 15px -5px rgba(189, 52, 254, 0.8);
        }

        #analyzeBtn:disabled {
            background: #2f2f35;
            color: #666;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            filter: none;
            animation: none;
        }

        #result {
            margin-top: 3rem;
            text-align: left;
            white-space: pre-wrap;
            background: #1b1b1f;
            padding: 2rem;
            border-radius: 16px;
            color: #eee;
            line-height: 1.7;
            display: none;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Markdown-like styling for result */
        #result strong {
            color: var(--secondary-color);
            font-weight: 700;
        }

        .loading {
            display: none;
            margin-top: 2.5rem;
            color: var(--text-muted);
            font-size: 1rem;
        }

        .file-name {
            margin-top: 1rem;
            font-weight: 500;
            color: var(--secondary-color);
            background: rgba(65, 209, 255, 0.1);
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(65, 209, 255, 0.2);
            font-size: 0.9rem;
        }
        
        .site-header {
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(15, 14, 20, 0.8);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .site-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            letter-spacing: -0.5px;
        }

        .site-footer {
            padding: 2rem 0 !important;
            margin-top: 4rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            background: transparent !important;
        }
        
        .site-footer__text {
            font-size: 0.9rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .spinner {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--primary-color);
            border-right-color: var(--secondary-color);
            animation: spin 1s linear infinite;
            filter: drop-shadow(0 0 15px var(--primary-color));
        }

        .spinner::after {
            content: '';
            position: absolute;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-bottom-color: #ff2d88;
            border-left-color: #fff;
            animation: spin-reverse 1.5s linear infinite;
            filter: drop-shadow(0 0 10px #ff2d88);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin-reverse {
            0% { transform: rotate(360deg); }
            100% { transform: rotate(-360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-container {
            background: #1e1e24;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px 20px 0 0;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .modal-close:hover {
            color: #fff;
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            line-height: 1.7;
            color: #e0e0e0;
            font-size: 1rem;
            white-space: pre-wrap;
        }

        .modal-body h1, .modal-body h2, .modal-body h3 {
            color: #fff;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-family: inherit;
            font-weight: 600;
        }
        
        .modal-body h1 { font-size: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; }
        .modal-body h2 { font-size: 1.3rem; }
        .modal-body h3 { font-size: 1.1rem; color: var(--secondary-color); }

        .modal-body strong {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: center;
            gap: 1rem;
            background: #1b1b1f;
            border-radius: 0 0 20px 20px;
        }

        /* Scroll to Top Button */
        #scrollTopBtn {
            position: absolute;
            bottom: 6rem;
            right: 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
            z-index: 10;
        }

        #scrollTopBtn:hover {
            transform: translateY(-3px);
            background: var(--primary-light);
        }

        /* Share Buttons with 3D effect */
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: inherit;
            font-size: 1rem;
            position: relative;
            top: 0;
        }

        .share-kakao {
            background: #FEE500;
            color: #000000;
            box-shadow: 0 4px 0 #c6b000;
        }

        .share-kakao:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #c6b000;
        }

        .share-kakao:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #c6b000;
        }

        .share-copy {
            background: #3a3a42;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 0 #222;
        }
        
        .share-copy:hover {
            background: #45454d;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #222;
        }

        .share-copy:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #222;
        }
    </style>
</head>

<body>

	<main class="site-main">
        <div class="lang-switcher">
            <a href="analysis.html" class="lang-link">KR</a>
            <a href="analysis-en.html" class="lang-link active">EN</a>
            <a href="analysis-es.html" class="lang-link">ES</a>
        </div>
        <div class="analysis-container">
            <h1 class="hero__title">Dance Video Precision Analysis</h1>
            <p class="hero__description">Upload your dance video and our Latin Dance Motion Analysis Engine<br>will analyze your moves, rhythm, and posture to provide feedback.</p>
            
            <div class="options-grid">
                <div>
                    <label class="section-title">Select Dance Genre</label>
                    <select id="danceGenre">
                        <option value="Salsa">Salsa</option>
                        <option value="Bachata">Bachata</option>
                        <option value="Kizomba">Kizomba</option>
                        <option value="Zouk">Zouk</option>
                    </select>
                </div>
                <div>
                    <label class="section-title">Select Video Type</label>
                    <select id="danceType">
                        <option value="Social">Social Dance</option>
                        <option value="Performance">Performance</option>
                    </select>
                </div>
            </div>

            <div class="upload-area" id="dropZone">
                <span class="upload-icon">üìÅ</span>
                <label for="videoInput" class="upload-btn-label">Select Video</label>
                <input type="file" id="videoInput" accept="video/*">
                <p class="upload-hint">or drag and drop video here</p>
                <div id="fileName" class="file-name"></div>
            </div>

            <button id="analyzeBtn" disabled>Start Analysis</button>
            
            <!-- Loading div removed, moved to modal -->
            
            <div id="result"></div>
        </div>
	</main>

    <!-- Result Modal -->
    <div id="resultModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Analysis Result</h3>
                <button id="modalCloseBtn" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="modal-body">
                <!-- Analysis content will be injected here -->
            </div>
            <button id="scrollTopBtn" title="Top">‚Üë</button>
            <div id="modalFooter" class="modal-footer">
                <button class="share-btn share-kakao" onclick="shareKakao()" style="margin-right: 10px;">
                    üí¨ Share on KakaoTalk
                </button>
                <button class="share-btn share-copy" onclick="copyResult()">
                    üìã Copy Result
                </button>
            </div>
        </div>
    </div>

    <script>
        // Kakao SDK Init
        try {
            Kakao.init('2a0f97309508f0405a563d70e1c01262'); 
        } catch (e) {
            console.warn("Kakao SDK init failed (Key not set)");
        }

        const videoInput = document.getElementById('videoInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const fileNameDiv = document.getElementById('fileName');
        const dropZone = document.getElementById('dropZone');
        
        // Modal Elements
        const resultModal = document.getElementById('resultModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        const modalFooter = document.getElementById('modalFooter');
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        let isAnalyzing = false;
        let latestAnalysisResult = "";
        let currentAnalysisId = null;

        // File selection handler
        videoInput.addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#fff';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length > 0) {
                videoInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = videoInput.files[0];
            if (file) {
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                
                if (file.size > 100 * 1024 * 1024) { // 100MB limit
                    alert(`File is too large (${sizeInMB} MB).\nOnly videos under 100MB are allowed.\n(Please compress before uploading)`);
                    videoInput.value = "";
                    fileNameDiv.textContent = "";
                    analyzeBtn.disabled = true;
                    return;
                }

                fileNameDiv.textContent = `Selected: ${file.name} (${sizeInMB} MB)`;
                analyzeBtn.disabled = false;
            } else {
                fileNameDiv.textContent = '';
                analyzeBtn.disabled = true;
            }
        }

        analyzeBtn.addEventListener('click', async () => {
            const file = videoInput.files[0];
            if (!file) return;

            isAnalyzing = true;
            latestAnalysisResult = "";

            // UI State Change
            analyzeBtn.disabled = true;
            document.getElementById('danceGenre').disabled = true;
            document.getElementById('danceType').disabled = true;
            document.querySelector('label[for="videoInput"]').style.pointerEvents = "none";
            document.querySelector('label[for="videoInput"]').style.opacity = "0.5";
            
            // Show Modal
            resultModal.style.display = 'flex';
            modalTitle.textContent = "Analysis in Progress";
            modalFooter.style.display = 'none';
            modalCloseBtn.style.display = 'none';
            document.body.style.overflow = 'hidden';

            try {
                const API_URL = "https://latindance-api.yama5993.workers.dev"; 

                // 1. Init
                console.log("Step 1: Init");
                modalBody.innerHTML = "<p>Establishing secure connection and initializing data transfer session...</p>";
                const initRes = await fetch(`${API_URL}?action=init`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        mimeType: file.type,
                        numBytes: file.size,
                        displayName: file.name
                    })
                });
                
                if (!initRes.ok) {
                    const text = await initRes.text();
                    throw new Error(`Init failed (${initRes.status}): ${text}`);
                }
                const { uploadUrl } = await initRes.json();

                // 2. Upload
                console.log("Step 2: Upload");
                modalBody.innerHTML = `
                    <div class="progress-status">Transmitting video data to analysis server...</div>
                    <div class="progress-text" id="progressPercent">0%</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.5); text-align:center; margin-top: 20px;">
                        (High-quality videos may take longer to transmit)
                    </p>
                `;

                const progressBar = modalBody.querySelector('#progressBar');
                const progressPercent = modalBody.querySelector('#progressPercent');

                const uploadRes = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", `${API_URL}?action=upload`);
                    xhr.setRequestHeader("X-Upload-Url", uploadUrl);
                    xhr.setRequestHeader("Content-Type", file.type);

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            if (progressBar && progressPercent) {
                                progressBar.style.width = `${percent}%`;
                                progressPercent.textContent = `${percent}%`;
                            }
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                                reject(new Error("Invalid JSON response from upload"));
                            }
                        } else {
                            reject(new Error(`Upload failed (${xhr.status}): ${xhr.responseText}`));
                        }
                    };

                    xhr.onerror = () => reject(new Error("Network error during upload"));
                    xhr.send(file);
                });

                const { fileUri, fileName } = uploadRes;

                // 3. Polling
                console.log("Step 3: Polling Status");
                modalBody.innerHTML = `
                    <div class="spinner"></div>
                    <p style="text-align:center">Preprocessing video and optimizing data on cloud server...</p>
                    <p style="font-size: 0.9rem; color: #888; text-align:center">Please wait a moment.</p>
                `;
                
                let isReady = false;
                for (let i = 0; i < 60; i++) { // Max 2 mins
                    const checkRes = await fetch(`${API_URL}?action=check_status`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ fileName })
                    });
                    
                    if (!checkRes.ok) throw new Error("Status check failed");
                    const statusData = await checkRes.json();
                    
                    if (statusData.state === "ACTIVE") {
                        isReady = true;
                        break;
                    }
                    if (statusData.state === "FAILED") {
                        throw new Error("Video processing failed at server side");
                    }
                    
                    // Wait 2s
                    await new Promise(r => setTimeout(r, 2000));
                }
                
                if (!isReady) throw new Error("Video processing timed out");

                // 4. Analyze
                console.log("Step 4: Analyze");
                modalBody.innerHTML = `
                    <div class="spinner"></div>
                    <p style="text-align:center">Latin Dance Motion Analysis Engine is precisely analyzing<br>joint points and rhythm frame by frame...</p>
                    <p style="font-size: 0.9rem; color: #888; text-align:center">(May take 1-2 minutes)</p>
                `;

                const genre = document.getElementById('danceGenre').value;
                const type = document.getElementById('danceType').value;

                let referenceDancers = "World Champion Level Dancers";
                let genreFocus = "Please focus on movement accuracy, rhythm, connection with partner, and posture.";
                
                // Default Format
                let analysisFormat = `
                    1. **Overall Review**: Overall feel of the dance, musical interpretation, atmosphere
                    2. **Leader Analysis**:
                    - **Pros**: (Describe specifically based on detailed scores below)
                    - **Cons & Improvements**: (Describe specifically based on detailed scores below)
                    - **Detailed Scores**:
                        - **Rhythm & Timing**: (0~10, to one decimal place)
                        - **Posture & Frame**: (0~10, to one decimal place)
                        - **Connection**: (0~10, to one decimal place)
                        - **Movement Accuracy**: (0~10, to one decimal place)
                        - **Artistry**: (0~10, to one decimal place)
                        - **Partnership**: (0~10, to one decimal place, breathing & care)
                    - **Overall Score**: (Average of above 6 items and Grade. e.g., "6.5 - Advanced Social Dancer". *Grade Criteria: 10(World Champion), 9(Top Pro), 8(Pro Instructor), 7(Semi-Pro/Performance Team), 6(Advanced Social), 5(High-Intermediate Social), 4(Intermediate Social), 3(Low-Intermediate Social), 2(Beginner), 1(Novice)*)
                    3. **Follower Analysis**:
                    - **Pros**: (Describe specifically based on detailed scores below)
                    - **Cons & Improvements**: (Describe specifically based on detailed scores below)
                    - **Detailed Scores**:
                        - **Rhythm & Timing**: (0~10, to one decimal place)
                        - **Posture & Frame**: (0~10, to one decimal place)
                        - **Connection**: (0~10, to one decimal place)
                        - **Movement Accuracy**: (0~10, to one decimal place)
                        - **Artistry**: (0~10, to one decimal place)
                        - **Partnership**: (0~10, to one decimal place, breathing & care)
                    - **Overall Score**: (Average of above 6 items and Grade. e.g., "6.5 - Advanced Social Dancer". *Grade Criteria: 10(World Champion), 9(Top Pro), 8(Pro Instructor), 7(Semi-Pro/Performance Team), 6(Advanced Social), 5(High-Intermediate Social), 4(Intermediate Social), 3(Low-Intermediate Social), 2(Beginner), 1(Novice)*)`;

                if (genre === "Salsa") {
                    referenceDancers = "Terry & Cecile, Fernando Sosa, Adolfo Indacochea, Eddie Torres";
                    if (type === "Performance") {
                        genreFocus = "This is a Salsa Performance. **High-difficulty turn patterns based on 'Clave Rhythm', flashy Footwork (Shines), and Lifts** are important. Please focus on stage showmanship, individual styling, and razor-sharp synchronization.";
                        analysisFormat = `
                    1. **Overall Review**: Concept, Choreography, Stage Presence
                    2. **Leader Performance Analysis**:
                    - **Pros**: (Technique, Footwork, Showmanship focus)
                    - **Cons & Improvements**: (Specific movement correction suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery & Accuracy**: (0~10)
                        - **Technique (Turn/Spin)**: (0~10)
                        - **Footwork & Shines**: (0~10)
                        - **Partner Support & Lifts**: (0~10, Stability)
                        - **Line & Posture**: (0~10, Body Extension)
                        - **Showmanship & Styling**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Performance Analysis**:
                    - **Pros**: (Technique, Styling, Showmanship focus)
                    - **Cons & Improvements**: (Specific movement correction suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery & Accuracy**: (0~10)
                        - **Technique (Turn/Spin/Flexibility)**: (0~10)
                        - **Footwork & Shines**: (0~10)
                        - **Line & Posture**: (0~10, Fingertips/Toes)
                        - **Showmanship & Styling**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    } else {
                        genreFocus = "Salsa is all about **'Clave Rhythm' based accurate steps and timing**. From a Social Dance perspective, please focus on comfortable leading/following, safety, and enjoyment.";
                        analysisFormat = `
                    1. **Overall Review**: Salsa energy, Clave rhythm, Partnership
                    2. **Leader Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Timing**: (0~10, Clave adherence)
                        - **Leading & Signals**: (0~10, Clarity & Tension)
                        - **Basic & Steps**: (0~10, Stability)
                        - **Pattern Flow**: (0~10, Natural flow)
                        - **Musicality**: (0~10, Interpretation)
                        - **Partnership & Manner**: (0~10, Eye contact & Care)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Timing**: (0~10, Maintaining beat)
                        - **Following & Tension**: (0~10, Reaction speed & Connection)
                        - **Basic & Steps**: (0~10, Stability)
                        - **Posture & Balance**: (0~10, Turn stability)
                        - **Partnership & Interaction**: (0~10, Enjoyment & Eye contact)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    }
                }
                else if (genre === "Bachata") {
                    referenceDancers = "Daniel & Desiree, Ataca & La Alemana, Marco & Sara, Luis & Andrea";
                    if (type === "Performance") {
                        genreFocus = "This is a Bachata Performance. **'Sensual Body Movement', 'Individual Styling', and 'Dramatic Musicality'** are important. Focus on emotional expression, flexibility, and the perfection of difficult Dips and Tricks.";
                        analysisFormat = `
                    1. **Overall Review**: Concept, Choreography, Stage Presence
                    2. **Leader Performance Analysis**:
                    - **Pros**: (Technique, Styling, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Body Movement/Isolation)**: (0~10)
                        - **Partner Support & Tricks**: (0~10, Stability)
                        - **Line & Posture**: (0~10)
                        - **Showmanship & Styling**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Performance Analysis**:
                    - **Pros**: (Technique, Styling, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Body Movement/Flexibility)**: (0~10)
                        - **Line & Posture**: (0~10)
                        - **Balance & Core**: (0~10)
                        - **Showmanship & Styling**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    } else {
                        genreFocus = "Bachata emphasizes **'Sensual Body Movement' and 'Cuban Motion'**. In Social Dance, proper distance, safe leading, and emotional connection are key.";
                        analysisFormat = `
                    1. **Overall Review**: Sensual feel, Musicality, Connection quality
                    2. **Leader Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Basic & Rhythm**: (0~10)
                        - **Frame & Posture**: (0~10)
                        - **Leading & Connection**: (0~10, Smoothness)
                        - **Body Movement**: (0~10, Wave/Isolation)
                        - **Musicality**: (0~10, Emotion & Breaks)
                        - **Partnership & Safety**: (0~10, Distance & Safety)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Basic & Rhythm**: (0~10)
                        - **Frame & Connection**: (0~10)
                        - **Following**: (0~10)
                        - **Body Movement**: (0~10, Flexibility & Hip)
                        - **Partnership & Chemistry**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    }
                }
                else if (genre === "Kizomba") {
                    referenceDancers = "Albir Rojas, Isabelle & Felicien";
                    if (type === "Performance") {
                        genreFocus = "This is a Kizomba Performance. **'Dissociation' and 'Fancy Footwork'** are important. Focus on intensity within restrained movement, perfect oneness with partner, and musicality expressing micro-beats.";
                        analysisFormat = `
                    1. **Overall Review**: Concept, Choreography, Stage Presence
                    2. **Leader Performance Analysis**:
                    - **Pros**: (Technique, Footwork, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Dissociation)**: (0~10)
                        - **Footwork**: (0~10, Saidas & Syncopation)
                        - **Partner Support & Leading**: (0~10)
                        - **Line & Posture**: (0~10)
                        - **Showmanship & Atmosphere**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Performance Analysis**:
                    - **Pros**: (Technique, Footwork, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Ginga/Dissociation)**: (0~10)
                        - **Footwork**: (0~10)
                        - **Line & Posture**: (0~10)
                        - **Balance & Core**: (0~10)
                        - **Showmanship & Atmosphere**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    } else {
                        genreFocus = "Kizomba is about **'Grounding' and 'Smooth Weight Transfer'**. In Social Dance, comfortable Embrace, adjusting steps to partner, and oneness in music are important.";
                        analysisFormat = `
                    1. **Overall Review**: Grounding, Connection density, Oneness with music
                    2. **Leader Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Grounding & Steps**: (0~10)
                        - **Connection & Holding**: (0~10, Embrace)
                        - **Leading**: (0~10, Weight transfer)
                        - **Musicality**: (0~10)
                        - **Dissociation**: (0~10)
                        - **Partnership & Care**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Grounding & Steps**: (0~10)
                        - **Connection & Holding**: (0~10)
                        - **Following**: (0~10)
                        - **Ginga & Movement**: (0~10)
                        - **Musicality**: (0~10)
                        - **Partnership & Trust**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    }
                }
                else if (genre === "Zouk") {
                    referenceDancers = "Kadu & Larissa, William & Paloma";
                    if (type === "Performance") {
                        genreFocus = "This is a Zouk Performance. **'Head Movement', 'Individual Styling', and 'Dynamic Flow'** are important. Focus on dramatic lines, counter-balance, lifts, and storytelling.";
                        analysisFormat = `
                    1. **Overall Review**: Concept, Choreography, Stage Presence
                    2. **Leader Performance Analysis**:
                    - **Pros**: (Technique, Styling, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Head Leading/Counter Balance)**: (0~10)
                        - **Partner Support & Lifts**: (0~10)
                        - **Line & Posture**: (0~10)
                        - **Showmanship & Styling**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Performance Analysis**:
                    - **Pros**: (Technique, Styling, Showmanship focus)
                    - **Cons & Improvements**: (Specific suggestions)
                    - **Detailed Scores**:
                        - **Choreography Mastery**: (0~10)
                        - **Technique (Head Movement/Cambr√©)**: (0~10)
                        - **Line & Posture**: (0~10)
                        - **Balance & Core**: (0~10)
                        - **Showmanship & Styling**: (0~10)
                        - **Musicality**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    } else {
                        genreFocus = "Zouk features **'Head Movement' and 'Flow'**. In Social Dance, safe leading protecting partner's neck/back and continuous flow are priority.";
                        analysisFormat = `
                    1. **Overall Review**: Flow, Natural Head Movement, Dynamics
                    2. **Leader Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Basic & Rhythm**: (0~10)
                        - **Connection & Frame**: (0~10)
                        - **Leading & Flow**: (0~10)
                        - **Head Movement Leading**: (0~10, Safety)
                        - **Dynamics**: (0~10)
                        - **Partnership & Safety**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)
                    3. **Follower Analysis**:
                    - **Pros**: (Specific details)
                    - **Cons & Improvements**: (Specific details)
                    - **Detailed Scores**:
                        - **Basic & Rhythm**: (0~10)
                        - **Connection & Axis**: (0~10)
                        - **Following**: (0~10)
                        - **Head Movement Tech**: (0~10)
                        - **Flexibility & Isolation**: (0~10)
                        - **Partnership & Breath**: (0~10)
                    - **Overall Score**: (Average & Grade. *Criteria: 10(World Champ) ~ 1(Novice)*)`;
                    }
                }

                const prompt = `
                    You are a professional Latin Dance (Salsa, Bachata, Kizomba, Zouk, etc.) analyst.

                    [IMPORTANT] First, verify if this is a dance video.
                    If the video is completely unrelated to dance (e.g., landscape, food, document, static screen, news, etc.), 
                    DO NOT analyze and ONLY output the following sentence and exit:
                    "Sorry, this does not appear to be a dance video. Please upload a dance video for precise analysis."

                    If it is a dance video, this is a ${genre || "Latin Dance"} ${type || "video"}.
                    Please analyze the unique characteristics of this video with an expert's eye.

                    [Criteria for 10-point Scale]
                    10 points represents the level of World Champions in this genre (${referenceDancers}).
                    Based on AI-learned data of these champions' **Posture, Connection, Musicality, and Movement Accuracy**, 
                    please evaluate relatively how close the dancers in the uploaded video are to this 'World Class' standard.
                    
                    Please provide the response in the following format (in English):
                    ${analysisFormat}
                    
                    [Focus Points for ${genre}]:
                    ${genreFocus}
                    `.trim();

                const analyzeRes = await fetch(`${API_URL}?action=analyze`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        fileUri: fileUri,
                        mimeType: file.type,
                        genre: genre,
                        type: type,
                        userPrompt: prompt
                    })
                });

                if (!analyzeRes.ok) {
                    const text = await analyzeRes.text();
                    throw new Error(`Analysis failed (${analyzeRes.status}): ${text}`);
                }
                
                const text = await analyzeRes.text();
                if (!text) throw new Error("Empty response from server");
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}...`);
                }
                
                const content = data.choices?.[0]?.message?.content || "Failed to retrieve analysis result.";
                latestAnalysisResult = content;

                // Save Result
                try {
                    const saveRes = await fetch(`${API_URL}?action=save_result`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            result: content,
                            genre: genre,
                            type: type
                        })
                    });
                    if (saveRes.ok) {
                        const saveData = await saveRes.json();
                        currentAnalysisId = saveData.id;
                        console.log("Result saved with ID:", currentAnalysisId);
                    }
                } catch (saveErr) {
                    console.warn("Failed to save result for sharing:", saveErr);
                }

                // Markdown Formatting
                const formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/### (.*?)\n/g, '<h3>$1</h3>') // H3
                    .replace(/## (.*?)\n/g, '<h2>$1</h2>') // H2
                    .replace(/# (.*?)\n/g, '<h1>$1</h1>') // H1
                    .replace(/\n/g, '<br>'); // Line breaks

                modalTitle.textContent = "Analysis Result";
                modalBody.innerHTML = formattedContent;
                modalFooter.style.display = 'flex';

            } catch (error) {
                console.error(error);
                alert(`Error: ${error.message}`);
                modalTitle.textContent = "Error Occurred";
                modalBody.innerHTML = `<p style="color:red">Detail: ${error.message}</p>`;
                modalFooter.style.display = 'none';
            } finally {
                isAnalyzing = false;
                modalCloseBtn.style.display = 'block';

                // UI Restore
                analyzeBtn.disabled = false;
                document.getElementById('danceGenre').disabled = false;
                document.getElementById('danceType').disabled = false;
                document.querySelector('label[for="videoInput"]').style.pointerEvents = "auto";
                document.querySelector('label[for="videoInput"]').style.opacity = "1";
            }
        });

        // Modal Functions
        function closeModal() {
            if (isAnalyzing) return;
            resultModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        resultModal.addEventListener('click', (e) => {
            if (isAnalyzing) return;
            if (e.target === resultModal) {
                closeModal();
            }
        });

        modalBody.addEventListener('scroll', () => {
            if (modalBody.scrollTop > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });

        scrollTopBtn.addEventListener('click', () => {
            modalBody.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Sharing Functions
        function shareKakao() {
            if (typeof Kakao === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://t1.kakaocdn.net/kakao_js_sdk/2.7.1/kakao.min.js';
                script.onload = () => {
                    try {
                        if (!Kakao.isInitialized()) {
                            Kakao.init('2a0f97309508f0405a563d70e1c01262');
                        }
                        shareKakao();
                    } catch (e) {
                        alert('Kakao SDK Init Failed: ' + e.message);
                    }
                };
                script.onerror = () => {
                    alert('Failed to load Kakao SDK.');
                };
                document.head.appendChild(script);
                return;
            }

            try {
                if (!Kakao.isInitialized()) {
                    Kakao.init('2a0f97309508f0405a563d70e1c01262');
                }

                const shareUrl = currentAnalysisId 
                    ? `https://latindance.kr/analysis-en.html?id=${currentAnalysisId}`
                    : 'https://latindance.kr/analysis-en.html';

                Kakao.Share.sendDefault({
                    objectType: 'feed',
                    content: {
                        title: 'Dance Video Precision Analysis',
                        description: 'AI analyzes your dance video and provides feedback. Try it now!',
                        imageUrl: 'https://latindance.kr/assets/images/analysis_kakao_profile.png?v=2',
                        link: {
                            mobileWebUrl: shareUrl,
                            webUrl: shareUrl,
                        },
                    },
                    buttons: [
                        {
                            title: 'View Result',
                            link: {
                                mobileWebUrl: shareUrl,
                                webUrl: shareUrl,
                            },
                        },
                    ],
                });
            } catch (err) {
                console.error('Kakao Share Error:', err);
                alert('Error sharing to KakaoTalk: ' + err.message);
            }
        }

        function copyResult() {
            if (!latestAnalysisResult) {
                alert('No result to copy.');
                return;
            }
            
            navigator.clipboard.writeText(latestAnalysisResult).then(() => {
                alert('Result copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy result.');
            });
        }

        // Load Shared Result
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('id');

            if (sharedId) {
                const API_URL = "https://latindance-api.yama5993.workers.dev";
                
                resultModal.style.display = 'flex';
                modalTitle.textContent = "Loading Shared Result...";
                modalBody.innerHTML = '<div class="spinner"></div><p style="text-align:center">Fetching result...</p>';
                modalFooter.style.display = 'none';
                modalCloseBtn.style.display = 'block';

                try {
                    const res = await fetch(`${API_URL}?action=get_result&id=${sharedId}`);
                    if (!res.ok) throw new Error("Result not found");
                    
                    const data = await res.json();
                    const content = data.result;
                    latestAnalysisResult = content;

                    const formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                        .replace(/## (.*?)\n/g, '<h2>$1</h2>')
                        .replace(/# (.*?)\n/g, '<h1>$1</h1>')
                        .replace(/\n/g, '<br>');

                    modalTitle.textContent = "Analysis Result (Shared)";
                    modalBody.innerHTML = formattedContent;
                    modalFooter.style.display = 'flex';
                    
                } catch (err) {
                    console.error(err);
                    modalTitle.textContent = "Error";
                    modalBody.innerHTML = `<p>Failed to load shared result.<br>${err.message}</p>`;
                }
            }
        });
    </script>
</body>
</html>